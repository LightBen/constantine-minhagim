---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const links = [
    { href: `/${lang}/halakha`, label: t("nav.halakha") },
    { href: `/${lang}/hazanout`, label: t("nav.hazanout") },
    { href: `/${lang}/cuisine`, label: t("nav.cuisine") },
    { href: `/${lang}/articles`, label: t("nav.articles") },
    {
        label: t("nav.more"),
        children: [
            { href: `/${lang}/rabbanim`, label: t("nav.rabbanim") },
            // { href: `/${lang}/english`, label: t("nav.english") },
            { href: `/${lang}/printouts`, label: t("nav.printouts") },
            { href: `/${lang}/donate`, label: t("nav.donate") },
            { href: `/${lang}/contact`, label: t("nav.contact") },
            { href: `/${lang}/about`, label: t("nav.about") },
        ],
    },
];

const { alternatePath } = Astro.props;
---

<header
    class="fixed w-full top-0 z-50 bg-white/90 dark:bg-brand-navy/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 transition-all duration-300 h-16 flex items-center shadow-sm transform"
>
    <div
        class="w-full sm:container mx-auto px-4 flex justify-between items-center"
    >
        <!-- Logo & Title -->
        <a
            href={`/${lang}/`}
            class="header-brand flex items-center gap-2 md:gap-3 group"
        >
            <div
                class="w-10 h-10 md:w-14 md:h-14 flex items-center justify-center p-1 transition-transform group-hover:scale-105"
            >
                <img
                    src="/img/cm-logo-icon.png"
                    alt="Logo"
                    class="w-full h-full object-contain dark:filter dark:brightness-0 dark:invert"
                />
            </div>
            <div class="sitename flex flex-col relative top-[2px]">
                <span
                    class={`${lang === "he" ? "text-lg" : "text-sm"} md:text-lg font-serif text-brand-blue dark:text-white uppercase tracking-wide leading-[1.0] md:leading-[1.2]`}
                >
                    {t("site.title.1")}
                </span>
                <span
                    class={`${lang === "he" ? "text-lg" : "text-sm"} md:text-lg font-serif text-brand-blue-light dark:text-white uppercase tracking-wide leading-[1.0] md:leading-[1.2]`}
                >
                    {t("site.title.2")}
                </span>
            </div>
        </a>

        <!-- Desktop Nav -->
        <nav class="hidden md:flex items-center gap-6">
            {
                links.map((link) =>
                    link.children ? (
                        <div class="relative group">
                            <button
                                class={`text-gray-700 dark:text-gray-300 hover:text-brand-blue dark:hover:text-brand-blue-light font-medium transition-colors ${lang === "he" ? "text-base font-bold" : "text-sm"} uppercase tracking-wider flex items-center gap-1 py-2`}
                            >
                                {link.label}
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-4 w-4 transition-transform group-hover:rotate-180"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                            </button>
                            <div class="absolute top-full left-0 pt-2 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0">
                                <div class="bg-white dark:bg-brand-navy border border-gray-200 dark:border-gray-800 rounded-lg shadow-xl overflow-hidden py-1">
                                    {link.children.map((child) => (
                                        <a
                                            href={child.href}
                                            class={`block px-4 py-2 ${lang === "he" ? "text-base font-bold" : "text-sm"} text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-brand-blue dark:hover:text-brand-gold transition-colors`}
                                        >
                                            {child.label}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ) : (
                        <a
                            href={link.href}
                            class={`text-gray-700 dark:text-gray-300 hover:text-brand-blue dark:hover:text-brand-blue-light font-medium transition-colors ${lang === "he" ? "text-base font-bold" : "text-sm"} uppercase tracking-wider relative group py-2`}
                        >
                            {link.label}
                            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-brand-blue dark:bg-brand-blue-light origin-left transform scale-x-0 transition-transform duration-300 group-hover:scale-x-100" />
                        </a>
                    ),
                )
            }
        </nav>

        <!-- Right Controls -->
        <div class="flex items-center gap-2 md:gap-3">
            <!-- Language Switcher -->
            {
                (() => {
                    const currentPath = Astro.url.pathname;
                    const otherLang = lang === "fr" ? "he" : "fr";
                    let newPath;

                    if (alternatePath) {
                        newPath = alternatePath;
                    } else {
                        newPath = currentPath.replace(
                            `/${lang}`,
                            `/${otherLang}`,
                        );
                        if (!newPath.includes(`/${otherLang}`)) {
                            // Fallback if path doesn't contain lang prefix (e.g. root)
                            newPath = `/${otherLang}/`;
                        }
                    }

                    return (
                        <a
                            href={newPath}
                            class="flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white hover:bg-gray-200 dark:hover:bg-white/20 transition-all font-bold text-xs"
                        >
                            {lang === "fr" ? "עב" : "FR"}
                        </a>
                    );
                })()
            }

            <!-- Theme Toggle -->
            <button
                id="theme-toggle"
                class="flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 dark:bg-white/10 text-brand-blue dark:text-white hover:bg-gray-200 dark:hover:bg-white/20 transition-all"
            >
                <!-- Sun Icon -->
                <svg
                    class="w-5 h-5 dark:hidden"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                    ></path>
                </svg>
                <!-- Moon Icon -->
                <svg
                    class="w-5 h-5 hidden dark:block"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                    ></path>
                </svg>
            </button>

            <!-- Mobile Menu Button -->
            <button
                id="menu-toggle"
                class="md:hidden flex items-center justify-center w-10 h-10 rounded-full text-brand-blue dark:text-white hover:bg-gray-100 dark:hover:bg-white/10 transition-colors"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Removed DrawerMenu from here to avoid z-index/fixed positioning issues with transform -->
</header>

<script>
    import { navigate } from "astro:transitions/client";

    document.addEventListener("astro:page-load", () => {
        // Theme Toggle Logic
        const themeToggle = document.getElementById("theme-toggle");
        const html = document.documentElement;

        themeToggle?.addEventListener("click", () => {
            const isDark = html.classList.contains("dark");
            const newTheme = isDark ? "light" : "dark";

            if (newTheme === "dark") {
                html.classList.add("dark");
                html.setAttribute("data-theme", "dark");
            } else {
                html.classList.remove("dark");
                html.setAttribute("data-theme", "light");
            }
            localStorage.setItem("theme", newTheme);
        });

        // Scroll Behavior
        let lastScrollY = window.scrollY;
        const header = document.querySelector("header");

        const updateHeader = () => {
            if (!header) return;
            const currentScrollY = window.scrollY;

            // Show header at top or scrolling up
            if (currentScrollY <= 0 || currentScrollY < lastScrollY) {
                header.classList.remove("-translate-y-full");
            }
            // Hide header scrolling down and not at top
            else if (
                currentScrollY > lastScrollY &&
                currentScrollY > 64 &&
                !document.body.classList.contains("overflow-hidden")
            ) {
                header.classList.add("-translate-y-full");
            }

            lastScrollY = currentScrollY;
        };

        window.addEventListener("scroll", updateHeader);

        // Mobile Menu Logic
        const menuToggle = document.getElementById("menu-toggle");
        // Note: The actual drawer logic is in DrawerMenu.astro, but the toggle button is here.
        // We need to dispatch a custom event or let DrawerMenu handle it if it listens to the button.
        // Looking at DrawerMenu.astro (assumed), it likely selects #menu-toggle.
        // We'll leave the click handling to DrawerMenu.astro if it does it globally,
        // or ensure DrawerMenu re-initializes too.
    });
</script>

<style>
    .sitename span {
        line-height: 1.2 !important;
    }
</style>
