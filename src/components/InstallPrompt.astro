---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div
    id="install-prompt"
    class="fixed bottom-4 left-4 right-4 md:left-auto md:right-8 md:bottom-8 md:w-96 z-50 transform transition-all duration-500 translate-y-20 opacity-0 pointer-events-none"
>
    <div
        class="bg-white/95 dark:bg-brand-navy/95 backdrop-blur-md border border-gray-200 dark:border-gray-700 rounded-2xl p-3 shadow-2xl flex items-center justify-between gap-3"
    >
        <div class="flex items-center gap-3 flex-1 min-w-0">
            <div
                class="w-10 h-10 bg-brand-blue rounded-xl flex-shrink-0 flex items-center justify-center p-2 shadow-sm"
            >
                <img
                    src="/cm-logo-icon.svg"
                    alt="App Icon"
                    class="filter brightness-0 invert w-full h-full"
                />
            </div>
            <div class="flex-1 min-w-0">
                <h3
                    class="m-0 font-bold text-sm text-gray-900 dark:text-white leading-tight"
                >
                    Constantine Minhagim
                </h3>
                <p
                    class="m-0 text-[10px] text-gray-500 dark:text-gray-400 leading-tight line-clamp-2"
                >
                    {
                        lang === "fr"
                            ? "Accès hors ligne rapide"
                            : "גישה מהירה לא מקוונת"
                    }
                </p>
            </div>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
            <button
                id="install-confirm"
                class="bg-brand-blue hover:bg-brand-blue-dark text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-md transition-colors whitespace-nowrap"
            >
                {lang === "fr" ? "Installer" : "התקן"}
            </button>
            <button
                id="install-dismiss"
                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 transition-colors"
                aria-label="Close"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    let deferredPrompt;
    const promptElement = document.getElementById("install-prompt");
    const installBtn = document.getElementById("install-confirm");
    const dismissBtn = document.getElementById("install-dismiss");

    // Hide function helper
    const hidePrompt = () => {
        if (!promptElement) return;
        promptElement.classList.add(
            "opacity-0",
            "translate-y-20",
            "pointer-events-none",
        );
    };

    // Show function helper
    const showPrompt = () => {
        if (!promptElement) return;
        promptElement.classList.remove(
            "opacity-0",
            "translate-y-20",
            "pointer-events-none",
        );
    };

    window.addEventListener("beforeinstallprompt", (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;

        // Show the prompts after a delay
        setTimeout(() => {
            showPrompt();
        }, 3000); // Reduced delay to 3s for better UX testing
    });

    installBtn?.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        hidePrompt();
    });

    dismissBtn?.addEventListener("click", () => {
        hidePrompt();
    });
</script>
