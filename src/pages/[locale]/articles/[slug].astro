---
import imgPeople from "../../../assets/img/people-parchment.png";
import imgPeopleSocial from "../../../assets/img/people-parchment-social.jpg";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import BottomNav from "../../../components/BottomNav.astro";
import { useTranslations } from "../../../i18n/utils";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const postsFr = await getCollection(
        "articles",
        ({ data }) => data.locale === "fr",
    );
    const postsHe = await getCollection(
        "articles",
        ({ data }) => data.locale === "he",
    );

    const getAlternateSlug = (post: any, otherPosts: any[]) => {
        if (!post.data.flamelinkId) return null;
        const match = otherPosts.find(
            (p) => p.data.flamelinkId === post.data.flamelinkId,
        );
        return match ? match.slug.split("/").pop() : null;
    };

    return [
        ...postsFr.map((post) => ({
            params: { locale: "fr", slug: post.slug.split("/").pop() },
            props: {
                post,
                alternateSlug: getAlternateSlug(post, postsHe),
            },
        })),
        ...postsHe.map((post) => ({
            params: { locale: "he", slug: post.slug.split("/").pop() },
            props: {
                post,
                alternateSlug: getAlternateSlug(post, postsFr),
            },
        })),
    ];
}

const { locale } = Astro.params;
const { post, alternateSlug } = Astro.props;
const t = useTranslations(locale as "fr" | "he");

const { Content } = await post.render();

const date = new Date(post.data.date || 0).toLocaleDateString(
    locale === "fr" ? "fr-FR" : "he-IL",
    {
        year: "numeric",
        month: "long",
        day: "numeric",
    },
);

const alternatePath = alternateSlug
    ? `/${locale === "fr" ? "he" : "fr"}/articles/${alternateSlug}`
    : null;
---

<BaseLayout
    title={`${post.data.title} - ${t("nav.articles")}`}
    description={post.data.description || undefined}
    image={post.data.banner ||
        post.data.thumbnail ||
        imgPeopleSocial.src}
    alternatePath={alternatePath}
>
    <Header alternatePath={alternatePath} />

    <main class="flex-1 pb-20 md:pb-8">
        <article class="bg-white dark:bg-brand-navy overflow-hidden mb-12">
            <!-- Banner -->
            <div class="h-64 md:h-96 w-full relative">
                <img
                    src={post.data.banner ||
                        post.data.thumbnail ||
                        imgPeople.src}
                    alt={post.data.title}
                    class="w-full h-full object-cover"
                />
                <div
                    class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"
                >
                </div>
                <div
                    class="absolute bottom-0 left-0 w-full p-6 md:p-8 text-white"
                >
                    <div class="max-w-4xl mx-auto">
                        <div
                            class="mb-2 text-sm font-medium bg-brand-blue-light/80 text-black inline-block px-2 py-1 rounded backdrop-blur-sm"
                        >
                            {t("nav.articles")}
                        </div>
                        <h1
                            class="text-3xl md:text-5xl font-serif font-bold leading-tight mb-2 drop-shadow-md text-white dark:text-gold"
                        >
                            {post.data.title}
                        </h1>
                        <div class="flex items-center gap-4 text-sm opacity-90">
                            <span>{date}</span>
                            {
                                post.data.author && (
                                    <span>â€¢ {post.data.author}</span>
                                )
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Body -->
            <div
                class="p-6 md:p-10 prose prose-lg dark:prose-invert max-w-4xl mx-auto"
            >
                <Content />
            </div>

            <!-- Tags -->
            {
                post.data.tags && (
                    <div class="px-6 pb-6 md:px-10 flex flex-wrap gap-2 max-w-4xl mx-auto">
                        {post.data.tags.map((tag) => (
                            <span class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 px-3 py-1 rounded-full text-sm">
                                #{tag}
                            </span>
                        ))}
                    </div>
                )
            }
        </article>
    </main>

    <Footer />
    <BottomNav />
</BaseLayout>
